---
NEP: 9999
Title: Expose Chain Id and Protocol Version
Author: Marcelo Fornet <marcelo@aurora.dev>
DiscussionsTo: https://github.com/near/NEPs/discussions/
Status: Review
Type: Standards Track
Category: Protocol
Created: 15-May-2022
---

## Summary

Add two new fields to Block Header: _Chain Id_ and _Protocol Version_. This will allow Light Clients to prevent accepting blocks form unintended domains and react appropriately to new versions of the protocol. This change will take place starting from protocol version **TBD**.

## Motivation

Light Clients depend on the content of the Block Headers (\*) to process and validate the whole network. It is enough one block per epoch to make progress, and with the information available to them, they can proof several assertions about the current status of the chain. However it is not possible to build small proofs about the current **Chain Id** and the current **Protocol Version**.

-   **Chain Id**: The chain security depends on the assumption, that a block at height X will be considered final, when more than 2/3 of the validators (weighted by stake) sign a block at height X + 1. It is considered a slashable behavior for a validator to sign two different blocks at the same height. However, we can't discard the possibility that the same validators key are used to validate two different parallel chains. This could potentially happen for example in case a fork of a NEAR chain takes place (see for example Ethereum vs Ethereum Classic), or in case the same set of validators for two different testnets.

-   **Protocol Version**: Some protocol updates might involve changes on the Block Header format, or the consensus algorithm. Even if Light Client implementations can be aware of this changes in advance, the block height at which the change will take place is not known. The current approach to deal with this issue is to be online when the change takes place, and update the Light Client at the proper height. Having access to the current Protocol Version on the Block Header will allow building adaptive Light Clients, that treat each block according to the current version of the protocol.

<!-- TODO: This two can be discussed separately, in case there exists two different opinions for each feature. -->

**Note**: The addition of _Protocol Version_ and _Chain Id_ are independent from each other. They are included in the same Proposal since they are trying to solve two different problems with a similar scope (Light Client reliability), and the solutions to both problems are related.

(\*) All mentions to `Block Header` in this document refers to `Block Header Lite`. This is one part of the header, and in particular it is the part used by Light Client to process and validate the chain.

### Rainbow Bridge

It is worth highlighting, that they Rainbow Bridge works by implementing a NEAR Light Client that is deployed on Ethereum as a smart contract.

-   Having access to the _Chain Id_ will improve the security of the Light Client, by making sure that no competing "honest" chains can trick the light client into accepting unintended blocks.
-   Having access to the _Protocol Version_ will allow Light Client maintainers to update the implementation in advance of the network upgrade, and deploy the updated code, without having any downtime.

## Rationale and alternatives

Both, _Chain Id_ and _Protocol Version_ must be included as fields on the Block Header (Lite), given this is the data that is accessible to Light Clients during the block verification.

In particular the Protocol Version must be the first field of the payload (see on nearcore: `struct BlockHeaderInnerLite`). The main reason is that since the data is serialized using borsh, a custom deserializer can be used to fetch the protocol version before deserializing the whole payload. This is useful in case the latest upgrade involve a change on the payload format, but that keeps the same header.

Some alternatives considered:

-   **Ignore the proposal altogether**: We have made it this far without this fields, so why is this a problem now? Introducing chain id, is trying to prevent a security issue, that can happen in an (acknowledged) unlikely, but possible, scenario. Protocol Version is improving Light Client developer experience, especially for NEAR Light Client on Ethereum, that requires a complex deployment process.
-   **Build proofs for each value**: There is no way to build small proofs that can be used to dynamically construct this values.

One drawback of this approach is that every block header payload increases.

## Specification

We are presenting how the internal data structures should be changed for the reference code.

```rust
pub type ProtocolVersion = u32;

pub enum BlockHeader {
    BlockHeaderV1(Box<BlockHeaderV1>),
    BlockHeaderV2(Box<BlockHeaderV2>),
    BlockHeaderV3(Box<BlockHeaderV3>),
    BlockHeaderV4(Box<BlockHeaderV4>), // <-- Introduce new version for BlockHeader
}

pub struct BlockHeaderV4 { // <-- Updated version from BlockHeaderV3
    pub prev_hash: CryptoHash,
    pub inner_lite: BlockHeaderInnerLiteV4, // <-- Use BlockHeaderInnerLiteV4
    pub inner_rest: BlockHeaderInnerRestV3,
    pub signature: Signature,
}

pub struct BlockHeaderInnerLiteV4 { // <-- Updated version from BlockHeaderInnerLite
    pub protocol_version: ProtocolVersion, // <-- Add Protocol Version **as the first field**
    pub chain_id: String, // <-- Add Chain Id
    pub height: BlockHeight,
    pub epoch_id: EpochId,
    pub next_epoch_id: EpochId,
    pub prev_state_root: MerkleHash,
    pub outcome_root: MerkleHash,
    pub timestamp: u64,
    pub next_bp_hash: CryptoHash,
    pub block_merkle_root: CryptoHash,
}
```

Since _protocol_version_ and _chain_id_ are included as part of the BlockHeaderInnerLiteV4 data structure, both fields will be included in the hash, so they can be easily verified during the validation of the block.

**Note**: Every future protocol update must keep the protocol version as the first argument.

## Future possibilities

Having the _Protocol Version_ as the first field will allow evolving the Block Header going forward, without requiring Light Clients to keep track of the current protocol version by themselves.

## Copyright

[copyright]: #copyright

Copyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/).
